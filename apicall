-- Step 1: Identify mismatched rows (single join)
WITH dq_mismatch_rows AS (
  SELECT
    t.cust_id,
    t.acct_num,
    t.mtn,
    t.col1 AS t_col1,
    s.col1 AS s_col1,
    t.col2 AS t_col2,
    s.col2 AS s_col2,
    t.col3 AS t_col3,
    s.col3 AS s_col3
    -- add more columns as needed
  FROM `project.dataset.Table_T` t
  JOIN `project.dataset.Table_S` s
    USING (cust_id, acct_num, mtn)
  WHERE t.hash_col <> s.hash_col
),

-- Step 2: Unpivot each column into a row for metrics calculation
unpivoted AS (
  SELECT
    cust_id,
    acct_num,
    mtn,
    col_name,
    t_value,
    s_value
  FROM dq_mismatch_rows
  UNPIVOT(
    (t_value, s_value) FOR col_name IN (
      (t_col1, s_col1) AS 'col1',
      (t_col2, s_col2) AS 'col2',
      (t_col3, s_col3) AS 'col3'
      -- add more columns here
    )
  )
)

-- Step 3: Compute metrics for each column
SELECT
  col_name,
  COUNT(*) AS total_mismatched_rows,
  COUNTIF(t_value IS DISTINCT FROM s_value) AS mismatch_count,
  COUNTIF(t_value IS NULL OR s_value IS NULL) AS null_count,
  ARRAY_AGG(STRUCT(cust_id, acct_num, mtn, t_value, s_value) LIMIT 10) AS sample_rows
FROM unpivoted
GROUP BY col_name
ORDER BY col_name;
