git clone https://github.com/GoogleCloudPlatform/DataflowTemplates.git
cd DataflowTemplates/v2/spanner-change-streams-to-bigquery

mvn clean package -DskipTests


gsutil mb -l us-central1 gs://my-bucket
gsutil cp target/spanner-change-streams-to-bigquery-bundled-0.1.jar gs://my-bucket/templates/spanner-change-streams-to-bigquery.jar


{
  "image": "gcr.io/dataflow-templates/latest/flex/Spanner_Change_Streams_to_BigQuery",
  "metadata": {
    "name": "Spanner Change Streams to BigQuery",
    "description": "Streaming data from Spanner to BigQuery using Change Streams",
    "parameters": [
      {
        "name": "spannerInstanceId",
        "label": "Spanner Instance ID",
        "helpText": "The Spanner instance ID",
        "paramType": "TEXT"
      },
      {
        "name": "spannerDatabaseId",
        "label": "Spanner Database ID",
        "helpText": "The Spanner database ID",
        "paramType": "TEXT"
      },
      {
        "name": "spannerChangeStreamName",
        "label": "Spanner Change Stream Name",
        "helpText": "The Spanner Change Stream Name",
        "paramType": "TEXT"
      },
      {
        "name": "bigQueryDataset",
        "label": "BigQuery Dataset",
        "helpText": "The BigQuery dataset name",
        "paramType": "TEXT"
      },
      {
        "name": "bigQueryTable",
        "label": "BigQuery Table",
        "helpText": "The BigQuery table name",
        "paramType": "TEXT"
      }
    ]
  }
}


gsutil cp spanner_to_bq_flex_template.json gs://my-bucket/templates/


gcloud dataflow flex-template run "spanner-cdc-to-bq" \
  --template-file-gcs-location="gs://my-bucket/templates/spanner_to_bq_flex_template.json" \
  --parameters spannerInstanceId=my-instance,spannerDatabaseId=my-database,spannerChangeStreamName=SingerStream,bigQueryDataset=my_dataset,bigQueryTable=my_table \
  --region=us-central1
