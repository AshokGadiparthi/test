import org.apache.beam.sdk.Pipeline;
import org.apache.beam.sdk.io.gcp.bigquery.BigQueryIO;
import org.apache.beam.sdk.options.PipelineOptions;
import org.apache.beam.sdk.options.PipelineOptionsFactory;
import org.apache.beam.sdk.transforms.DoFn;
import org.apache.beam.sdk.transforms.ParDo;
import org.apache.beam.sdk.values.PCollection;
import redis.clients.jedis.Jedis;
import com.google.api.services.bigquery.model.TableRow;
import java.util.Set;
import java.util.List;

public class DebugBigQueryToRedis {

    private static final String REDIS_HOST = "your-redis-host";
    private static final int REDIS_PORT = 6379;
    private static final String NAMESPACE = "sectables:";

    /**
     * Step 1: Update Redis - Store `ref_col` as Key with "Y" as Value
     */
    static class UpdateRedisFn extends DoFn<TableRow, Void> {
        private transient Jedis jedis;
        private int recordCount = 0;  // Counter for added records

        @Setup
        public void setup() {
            jedis = new Jedis(REDIS_HOST, REDIS_PORT);
        }

        @ProcessElement
        public void processElement(ProcessContext c) {
            String refColValue = (String) c.element().get("ref_col");

            if (refColValue != null) {
                jedis.set(NAMESPACE + refColValue, "Y");  // Store in Redis with Namespace Prefix
                System.out.println("‚úÖ Added to Redis: " + NAMESPACE + refColValue);
                recordCount++;
            }
        }

        @FinishBundle
        public void finishBundle() {
            long totalCount = jedis.dbSize();  // Total keys in Redis
            List<String> sampleValues = jedis.keys(NAMESPACE + "*").stream().limit(5).toList();  // Get first 5 records

            System.out.println("üìå Total Records in Redis: " + totalCount);
            System.out.println("üìå Sample Records from Redis: " + sampleValues);
        }

        @Teardown
        public void teardown() {
            jedis.close();
        }
    }

    /**
     * Step 2: Remove Outdated Keys from Redis (Keys Not in BigQuery)
     */
    static class RemoveOutdatedRedisFn extends DoFn<TableRow, Void> {
        private transient Jedis jedis;
        private int removedCount = 0;

        @Setup
        public void setup() {
            jedis = new Jedis(REDIS_HOST, REDIS_PORT);
        }

        @ProcessElement
        public void processElement(ProcessContext c) {
            String refColValue = (String) c.element().get("ref_col");

            if (refColValue != null && jedis.exists(NAMESPACE + refColValue)) {
                jedis.del(NAMESPACE + refColValue);
                System.out.println("‚ùå Removed from Redis: " + NAMESPACE + refColValue);
                removedCount++;
            }
        }

        @FinishBundle
        public void finishBundle() {
            System.out.println("‚úÖ Total Records Removed from Redis: " + removedCount);
        }

        @Teardown
        public void teardown() {
            jedis.close();
        }
    }

    public static void main(String[] args) {
        PipelineOptions options = PipelineOptionsFactory.fromArgs(args).withValidation().create();
        Pipeline pipeline = Pipeline.create(options);

        // Step 1: Read latest BigQuery `ref_col` values
        PCollection<TableRow> bigQueryData = pipeline.apply("ReadFromBigQuery",
                BigQueryIO.readTableRows().from("your_project.your_dataset.employee"));

        // Step 2: Update Redis with new/updated values (with namespace)
        bigQueryData.apply("UpdateRedis", ParDo.of(new UpdateRedisFn()));

        // Step 3: Remove outdated entries from Redis (with namespace)
        bigQueryData.apply("RemoveOldFromRedis", ParDo.of(new RemoveOutdatedRedisFn()));

        pipeline.run().waitUntilFinish();
    }
}
