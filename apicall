CREATE OR REPLACE TABLE `project.dataset.dq_column_summary` AS
SELECT
  col_name,
  COUNTIF(t_value IS NULL) AS source_null_count,
  COUNTIF(s_value IS NULL) AS target_null_count,
  
  -- True mismatches after normalization
  COUNTIF(
    (t_value IS NULL AND s_value IS NOT NULL)
    OR (t_value IS NOT NULL AND s_value IS NULL)
    OR (SAFE_CAST(t_value AS STRING) IS DISTINCT FROM SAFE_CAST(s_value AS STRING))
  ) AS mismatch_count,

  -- Sample of mismatched records
  ARRAY_AGG(
    STRUCT(
      cust_id,
      acct_num,
      mtn,
      t_value AS source_value,
      s_value AS target_value
    ) 
    LIMIT 10
  ) AS mismatch_sample

FROM `project.dataset.dq_unpivoted`
GROUP BY col_name
ORDER BY mismatch_count DESC;
