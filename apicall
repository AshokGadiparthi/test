WITH data AS (
  SELECT
    payload_json,
    COALESCE(
      CAST(JSON_VALUE(payload_json, '$.MODIFIED_TIMESTAMP') AS TIMESTAMP),
      CAST(JSON_VALUE(payload_json, '$.DB_TIMESTAMP') AS TIMESTAMP),
      CAST(JSON_VALUE(payload_json, '$.CREATE_TIMESTAMP') AS TIMESTAMP)
    ) AS expected_ts,
    'STALE' AS actual_category
  FROM `project.dataset.stale_table`
  
  UNION ALL

  SELECT
    payload_json,
    COALESCE(
      CAST(JSON_VALUE(payload_json, '$.MODIFIED_TIMESTAMP') AS TIMESTAMP),
      CAST(JSON_VALUE(payload_json, '$.DB_TIMESTAMP') AS TIMESTAMP),
      CAST(JSON_VALUE(payload_json, '$.CREATE_TIMESTAMP') AS TIMESTAMP)
    ) AS expected_ts,
    'NON_STALE' AS actual_category
  FROM `project.dataset.non_stale_table`
)

SELECT *,
  CASE 
    WHEN expected_ts < TIMESTAMP('2025-12-11') THEN 'STALE'
    ELSE 'NON_STALE'
  END AS expected_category
FROM data
WHERE actual_category != expected_category;
