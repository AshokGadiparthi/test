import com.google.cloud.bigquery.*;

import java.util.ArrayList;
import java.util.List;

public class BigQueryMapper {
    private final BigQuery bigquery;

    public BigQueryMapper(BigQuery bigquery) {
        this.bigquery = bigquery;
    }

    public List<SampleRow> fetchData() {
        String query = "SELECT id, records FROM `project.dataset.sample_table`";
        QueryJobConfiguration queryConfig = QueryJobConfiguration.newBuilder(query).build();

        TableResult result;
        try {
            result = bigquery.query(queryConfig);
        } catch (Exception e) {
            throw new RuntimeException("Query failed", e);
        }

        List<SampleRow> rows = new ArrayList<>();
        for (FieldValueList row : result.iterateAll()) {
            String id = row.get("id").getStringValue();

            // Read ARRAY<STRUCT>
            List<RecordItem> recordList = new ArrayList<>();
            for (FieldValue recordVal : row.get("records").getRepeatedValue()) {
                FieldValueList struct = recordVal.getRecordValue();
                String col1 = struct.get("col1").getStringValue();
                String col2 = struct.get("col2").getStringValue();
                recordList.add(new RecordItem(col1, col2));
            }

            rows.add(new SampleRow(id, recordList));
        }
        return rows;
    }
}
